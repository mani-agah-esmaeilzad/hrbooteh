"use strict";(()=>{var e={};e.id=344,e.ids=[344],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},35816:e=>{e.exports=require("process")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},95346:e=>{e.exports=require("timers")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},28504:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>E,staticGenerationAsyncStorage:()=>x});var r={};t.r(r),t.d(r,{POST:()=>m});var a=t(49303),n=t(88716),i=t(60670),o=t(87070),c=t(95456),u=t(84235),l=t(97640),p=t(70822),d=t(38990);async function m(e){try{let s;let t=e.headers.get("authorization"),r=(0,c.oA)(t||void 0);if(!r)return o.NextResponse.json({success:!1,message:"توکن احراز هویت ارائه نشده است"},{status:401});try{s=(0,c.fS)(r)}catch(e){return o.NextResponse.json({success:!1,message:"توکن نامعتبر یا منقضی شده است"},{status:401})}let a=await e.json(),n=u.$G.safeParse(a);if(!n.success)return o.NextResponse.json({success:!1,message:"داده‌های ورودی نامعتبر است",error:n.error.errors[0]?.message},{status:400});let{message:i,session_id:m}=n.data,g=s.userId,_=await (0,d._3)();if(!_)throw Error("Failed to get database connection");try{let[e]=await _.execute("SELECT first_name, last_name FROM users WHERE id = ?",[g]),s=Array.isArray(e)&&e.length>0?e[0]:null,t=s?`${s.first_name} ${s.last_name}`.trim():"کاربر",r=(0,l.NU)(),[a]=await _.execute("SELECT * FROM assessments WHERE user_id = ? ORDER BY created_at DESC LIMIT 1",[g]);if(!Array.isArray(a)||0===a.length)return o.NextResponse.json({success:!1,message:"ارزیابی فعالی یافت نشد"},{status:404});let n=a[0],c=n.score||0,[u]=await _.execute('SELECT COUNT(*) as count FROM chat_messages WHERE assessment_id = ? AND message_type = "user"',[n.id]),d=Array.isArray(u)&&u.length>0?u[0].count:0;if(d>=r.scenario_parts.length){let[e]=await _.execute("SELECT * FROM chat_messages WHERE assessment_id = ? ORDER BY created_at ASC",[n.id]);Array.isArray(e);let s=(0,l.vH)(c,{},r);return await _.execute("UPDATE assessments SET score = ?, level = ?, description = ?, completed_at = NOW() WHERE id = ?",[c,s.analysis.assessment.level,s.analysis.assessment.description,n.id]),o.NextResponse.json({success:!0,message:"ارزیابی تکمیل شد",data:s})}let x=r.scenario_parts[d],E=(0,p.dx)(i,x.dimensions_to_analyze),h=c;if(E&&Array.isArray(E))for(let e of E)e&&"number"==typeof e.score&&(h+=e.score);if(await _.execute("INSERT INTO chat_messages (assessment_id, user_id, message_type, content, character_name) VALUES (?, ?, ?, ?, ?)",[n.id,g,"user",i,"User"]),await _.execute("UPDATE assessments SET score = ? WHERE id = ?",[h,n.id]),d>=r.scenario_parts.length-1){let e=(0,l.vH)(h,{},r);return await _.execute("UPDATE assessments SET level = ?, description = ?, completed_at = NOW() WHERE id = ?",[e.analysis.assessment.level,e.analysis.assessment.description,n.id]),o.NextResponse.json({success:!0,message:"ارزیابی تکمیل شد",data:e})}let y=d+1;if(y<r.scenario_parts.length){let e=r.scenario_parts[y].dialogue.map(e=>({...e,content:e.content.replace(/{user_name}/g,t)}));for(let s of e)await _.execute("INSERT INTO chat_messages (assessment_id, user_id, message_type, content, character_name) VALUES (?, ?, ?, ?, ?)",[n.id,g,"ai1",s.content,s.character]);let s={type:"ai_turn",messages:e,current_score:h,session_id:m,current_part:y};return o.NextResponse.json({success:!0,message:"بخش بعدی سناریو شروع شد",data:s})}{let e=(0,l.vH)(h,{},r);return await _.execute("UPDATE assessments SET level = ?, description = ?, completed_at = NOW() WHERE id = ?",[e.analysis.assessment.level,e.analysis.assessment.description,n.id]),o.NextResponse.json({success:!0,message:"ارزیابی تکمیل شد",data:e})}}finally{_.release()}}catch(e){return console.error("خطا در پردازش چت:",e),o.NextResponse.json({success:!1,message:"خطای سرور. لطفاً دوباره تلاش کنید"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/assessment/chat-independence/route",pathname:"/api/assessment/chat-independence",filename:"route",bundlePath:"app/api/assessment/chat-independence/route"},resolvedPagePath:"/root/hrbooteh/src/app/api/assessment/chat-independence/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:x,serverHooks:E}=g,h="/api/assessment/chat-independence/route";function y(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:x})}},84235:(e,s,t)=>{t.d(s,{$G:()=>i,dm:()=>a,gY:()=>n});var r=t(7410);let a=r.z.object({username:r.z.string().min(3,"نام کاربری باید حداقل ۳ کاراکتر باشد"),password:r.z.string().min(6,"رمز عبور باید حداقل ۶ کاراکتر باشد")}),n=r.z.object({username:r.z.string().min(3,"نام کاربری باید حداقل ۳ کاراکتر باشد"),email:r.z.string().email("ایمیل معتبر نیست"),password:r.z.string().min(6,"رمز عبور باید حداقل ۶ کاراکتر باشد"),password_confirmation:r.z.string(),first_name:r.z.string().min(2,"نام باید حداقل ۲ کاراکتر باشد"),last_name:r.z.string().min(2,"نام خانوادگی باید حداقل ۲ کاراکتر باشد"),phone_number:r.z.string().optional().nullable(),age:r.z.string().optional().nullable().or(r.z.number().min(1).max(120).optional().nullable()),education_level:r.z.string().optional().nullable(),work_experience:r.z.string().optional().nullable()}).refine(e=>e.password===e.password_confirmation,{message:"رمزهای عبور یکسان نیستند",path:["password_confirmation"]}),i=r.z.object({message:r.z.string().min(1,"پیام نمی‌تواند خالی باشد"),session_id:r.z.string().min(1,"شناسه جلسه معتبر نیست")});r.z.object({success:r.z.boolean(),message:r.z.string(),data:r.z.any().optional(),error:r.z.string().optional()})}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[276,240,482,23,410,643,517],()=>t(28504));module.exports=r})();