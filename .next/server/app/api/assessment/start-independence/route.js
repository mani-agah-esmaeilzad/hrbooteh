"use strict";(()=>{var e={};e.id=188,e.ids=[188],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},35816:e=>{e.exports=require("process")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},95346:e=>{e.exports=require("timers")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},12621:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>l,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>x});var r={};t.r(r),t.d(r,{POST:()=>d});var a=t(49303),n=t(88716),i=t(60670),o=t(87070),u=t(95456),c=t(97640),p=t(38990);async function d(e){try{let s;let t=e.headers.get("authorization"),r=(0,u.oA)(t||void 0);if(!r)return o.NextResponse.json({success:!1,message:"توکن احراز هویت ارائه نشده است"},{status:401});try{s=(0,u.fS)(r)}catch(e){return o.NextResponse.json({success:!1,message:"توکن نامعتبر یا منقضی شده است"},{status:401})}let a=s.userId,n=await (0,p._3)();if(!n)throw Error("Failed to get database connection");try{let[e]=await n.execute("SELECT first_name, last_name FROM users WHERE id = ?",[a]),s=Array.isArray(e)&&e.length>0?e[0]:null,t=s?`${s.first_name} ${s.last_name}`.trim():"کاربر",r=(0,c.NU)(),i=(0,c.xv)(),u=r.scenario_parts[0],[p]=await n.execute("INSERT INTO assessments (user_id, questionnaire_id, score, max_score) VALUES (?, ?, ?, ?)",[a,1,0,r.scoring_rules.max_score]),d=p.insertId;await n.execute("INSERT INTO assessment_states (session_id, state_data, created_at) VALUES (?, ?, NOW())",[i,JSON.stringify({type:"independence_scenario",score:0,current_question_index:0,answers:{},history:[]})]);let m=u.dialogue.map(e=>({...e,content:e.content.replace(/{user_name}/g,t)}));for(let e of m)await n.execute("INSERT INTO chat_messages (assessment_id, user_id, message_type, content, character_name) VALUES (?, ?, ?, ?, ?)",[d,a,"ai1",e.content,e.character]);return o.NextResponse.json({success:!0,message:"سناریوی استقلال شروع شد",data:{type:"ai_turn",messages:m,session_id:i,current_score:0,assessment_id:d,current_part:0}})}finally{n.release()}}catch(e){return console.error("خطا در شروع سناریو:",e),o.NextResponse.json({success:!1,message:"خطای سرور. لطفاً دوباره تلاش کنید"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/assessment/start-independence/route",pathname:"/api/assessment/start-independence",filename:"route",bundlePath:"app/api/assessment/start-independence/route"},resolvedPagePath:"/root/hrbooteh/src/app/api/assessment/start-independence/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:l,staticGenerationAsyncStorage:x,serverHooks:_}=m,g="/api/assessment/start-independence/route";function h(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:x})}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[276,240,482,23,643,517],()=>t(12621));module.exports=r})();